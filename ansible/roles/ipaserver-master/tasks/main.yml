---
- name: Install FreeIPA master (5-7 minutes)
  tags:
    - ipaserver-master
    - ipa-install
  command: >
    ipa-server-install -U
    --realm {{ ansible_domain | upper }}
    --domain {{ ansible_domain | lower }}
    --hostname {{ ansible_fqdn }}
    --ds-password {{ ipa_dm_password }}
    --admin-password {{ ipa_admin_password }}
    --ip-address {{ ansible_default_ipv4.address }}
    --setup-dns
    --reverse-zone={{ reversezone.reversezone }}
    {{ '--forwarder=%s' % dns_forwarder['nameservers'][0] if enable_network else '--no-forwarders' }}
  when: not ipa_installed

- name: Install KRA on FreeIPA master (2-3 minutes)
  tags:
    - ipaserver-master
    - ipa-install
  command: >
    ipa-kra-install -U
    -p {{ ipa_dm_password }}
  args:
    creates: /etc/pki/pki-tomcat/kra/CS.cfg

- name: Make sure named-pkcs11 DNS is running
  tags:
    - ipaserver-master
    - ipa-install
  service: name=named-pkcs11 state=started

- name: wait for services to come up
  tags:
    - ipaserver-master
    - ipa-install
  wait_for: port={{ item }} delay=0 timeout=30
  with_items:
    - 53
    - 88
    - 464
    - 749
    - 389
    - 636
    - 80
    - 443
    - 8080
    - 8443

- name: Enable global DNS sync ptr
  tags:
    - ipaserver-master
    - ipa-install
  ipa:
    args="dnsconfig-mod --allow-sync-ptr=TRUE"
    password="{{ ipa_admin_password }}"
    ignore_no_modifications=true

- name: Enable DNS sync ptr
  tags:
    - ipaserver-master
    - ipa-install
  ipa:
    args="dnszone-mod {{ ansible_domain }}. --allow-sync-ptr=TRUE"
    password="{{ ipa_admin_password }}"
    ignore_no_modifications=true

- name: Enable reverse DNS sync ptr
  tags:
    - ipaserver-master
    - ipa-install
  ipa:
    args="dnszone-mod {{ reversezone.reversezone }} --allow-sync-ptr=TRUE"
    password="{{ ipa_admin_password }}"
    ignore_no_modifications=true

- name: sync client clocks
  tags:
    - ipaserver-master
    - ipa-install
  command: ntpdate {{ ansible_default_ipv4.address }}
  delegate_to: "{{item}}"
  with_items: "{{ groups['ipa_client'] }}"
  register: result
  failed_when: "result.rc !=0 and 'NTP socket is in use' not in result.stderr"
  changed_when: result.rc == 0

- name: change replicas' resolv.conf to use FreeIPA DNS
  tags:
    - ipaserver-master
    - ipa-install
  template: src=etc_resolvconf dest=/etc/resolv.conf
  delegate_to: "{{item}}"
  with_items: "{{ groups['ipaserver_replica'] }}"

- name: change clients' resolv.conf to use FreeIPA DNS
  tags:
    - ipaserver-master
    - ipa-install
  template: src=etc_resolvconf dest=/etc/resolv.conf
  delegate_to: "{{item}}"
  with_items: "{{ groups['ipa_client'] }}"

- name: change master's resolv.conf to use FreeIPA DNS
  tags:
    - ipaserver-master
    - ipa-install
  template: src=etc_resolvconf dest=/etc/resolv.conf

- name: signal FreeIPA master has been deployed
  tags:
    - ipaserver-master
    - ipa-install
  file: path=/etc/ipa/MASTER_DEPLOYED state=touch

- name: Create Firefox prefs
  tags:
    - ipaserver-master
    - ipa-install
  template: src=firefox_prefs dest=/etc/ipa/prefs.js

- name: Fetch Firefox prefs
  tags:
    - ipaserver-master
    - ipa-install
    - fetch
  fetch: src=/etc/ipa/prefs.js
         dest={{ vagrant_root }}/inventory/prefs.js
         flat=yes

- name: Fetch krb5config
  tags:
    - ipaserver-master
    - ipa-install
    - fetch
  fetch: src=/etc/krb5.conf
         dest={{ vagrant_root }}/inventory/krb5.conf
         flat=yes

- name: Fetch resolv.conf
  tags:
    - ipaserver-master
    - ipa-install
    - fetch
  fetch: src=/etc/resolv.conf
         dest={{ vagrant_root }}/inventory/resolv.conf
         flat=yes

- name: Fetch cacert
  tags:
    - ipaserver-master
    - ipa-install
    - fetch
  fetch: src=/etc/ipa/ca.crt
         dest={{ vagrant_root }}/inventory/ca.crt
         flat=yes

- name: Fetch kra agent pem file
  tags:
    - ipaserver-master
    - ipa-install
    - fetch
  fetch: src=/etc/httpd/alias/kra-agent.pem dest={{ vagrant_root }}/inventory/kra-agent.pem flat=yes
